<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="description" content="" />
    <meta name="author" content="Ahmad Sulaeman (asaeles)" />
    <title>Catalog Manager</title>

    <!-- <<<<<<< External Style Sheets >>>>>>> -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
      integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf"
      crossorigin="anonymous"
    />

    <!-- <<<<<<< Internal Style Sheet >>>>>>> -->
    <link href="css/app.css" rel="stylesheet" />

    <!-- <<<<<<< External Java Scripts >>>>>>> -->
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
    <script
      src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
      integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://code.jquery.com/jquery-3.3.1.min.js"
      integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
      integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>
    <script src="https://apis.google.com/js/platform.js?onload=start"></script>

    <!-- <<<<<<< Internal Java Scripts >>>>>>> -->
    <script src="js/auth.js"></script>
    <script src="js/catalog.js"></script>
    <script src="js/crud.js"></script>

    <!-- Google O-Auth stuff (recommended to be last) -->
    <meta name="google-signin-scope" content="email profile openid" />
    <meta
      name="google-signin-client_id"
      content="267868166673-57jgeoaujf3qjpk0npn6qana09i74hp0.apps.googleusercontent.com"
    />
    <script src="https://apis.google.com/js/platform.js" async defer></script>
  </head>

  <body id="my-body">
    <!-- <<<<<<< Header Start >>>>>>> -->
    <header
      id="sign-in-header"
      class="d-flex flex-column flex-sm-row align-items-center p-3 px-sm-4 mb-3 bg-white border-bottom shadow-sm"
    >
      <h5 class="my-0 mr-sm-auto font-weight-normal">Catalog Manager</h5>
      <nav class="my-2 my-sm-0 mr-sm-3">
        <a id="sign-out-link" class="p-2 text-dark d-none" href="#">Sign out</a>
        <a
          id="sign-in-link"
          class="p-2 text-dark"
          href="#"
          data-toggle="modal"
          data-target="#sign-in-modal"
          >Sign in</a
        >
      </nav>
      <a
        id="sign-up-link"
        class="btn btn-outline-primary"
        href="#"
        data-toggle="modal"
        data-target="#sign-up-modal"
        data-whatever=""
        >Sign up</a
      >
      <div
        id="g-signin"
        class="g-signin2 btn"
        data-onsuccess="onSignIn"
        data-theme="dark"
      ></div>
      <img
        id="profile-picture"
        class="img-thumbnail thumb-post d-none"
      />
    </header>

    <!-- <<<<<<< Title Start >>>>>>> -->
    <div class="pricing-header px-3 py-3 pt-md-5 pb-md-4 mx-auto text-center">
      <h1 class="display-4">Categorized Items</h1>
      <p class="lead">
        Quickly build an effective categories and sub-items catalog in this
        Single Page App.
      </p>
    </div>

    <!-- <<<<<<< Container Start >>>>>>> -->
    <!-- Originally empty will be filled by AJAX calls -->
    <div id="container" class="container" ng-app></div>

    <!-- <<<<<<< Footer Start >>>>>>> -->
    <footer class="pt-4 mt-3 my-md-5 pt-md-5 border-top">
      <div class="row">
        <div class="col-12 col-md">
          <small class="d-block mb-3 text-muted text-center"
            >&copy; asaeles 1981-<script>
              document.write(new Date().getFullYear());
            </script></small
          >
        </div>
      </div>
    </footer>

    <!-- <<<<<<< Modals Start >>>>>>> -->

    <!---------- Sign In Modal ---------->
    <div
      class="modal fade"
      id="sign-in-modal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="sign-in-modalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="sign-in-modalLabel">Sign In</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <form id="sign-in-form" class="needs-validation" novalidate>
            <div class="modal-body">
              <div class="form-row">
                <label for="username-in" class="col-form-label">Username</label>
                <input
                  type="text"
                  class="form-control"
                  id="username-in"
                  placeholder="Username"
                  autocomplete="username"
                  required
                />
                <div id="username-in-error" class="invalid-feedback">
                  Please provide a valid username
                </div>
              </div>
              <div class="form-row">
                <label for="password" class="col-form-label">Password</label>
                <input
                  type="password"
                  class="form-control"
                  id="password-in"
                  placeholder="Password"
                  autocomplete="new-password"
                  required
                />
                <div class="invalid-feedback">
                  Please provide a password
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-dismiss="modal"
              >
                Close
              </button>
              <button type="button" id="sign-in-button" class="btn btn-primary">
                Sign In
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!---------- Sign Up Modal ---------->
    <div
      class="modal fade"
      id="sign-up-modal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="sign-up-modalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="sign-up-modalLabel">Sign up</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <form id="sign-up-form" class="needs-validation" novalidate>
            <div class="modal-body">
              <div class="form-row">
                <label for="username-up" class="col-form-label">Username</label>
                <input
                  type="text"
                  class="form-control"
                  id="username-up"
                  placeholder="Username"
                  autocomplete="username"
                  required
                />
                <div id="username-up-error" class="invalid-feedback">
                  Please provide a valid username
                </div>
              </div>
              <div class="form-row">
                <label for="password-up-1" class="col-form-label"
                  >Password</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="password-up-1"
                  placeholder="Password"
                  autocomplete="new-password"
                  required
                />
                <div class="invalid-feedback">
                  Please provide a password
                </div>
              </div>
              <div class="form-row">
                <label for="password-up-2" class="col-form-label"
                  >Re-type password</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="password-up-2"
                  placeholder="Re-type password"
                  autocomplete="new-password"
                  required
                />
                <div class="invalid-feedback">
                  Passwords don't match
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-dismiss="modal"
              >
                Close
              </button>
              <button type="button" id="sign-up-button" class="btn btn-primary">
                Sign Up
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!---------- CRUD Modal ---------->
    <div
      class="modal fade"
      id="crud-modal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="crud-title"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="crud-title">Title</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form>
              <div class="form-group">
                <label id="crud-label" for="crud-value" class="col-form-label"
                  >Name:</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="crud-value"
                  placeholder="Name"
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
            <button id="crud-button" type="button" class="btn btn-primary">
              Action
            </button>
          </div>
        </div>
      </div>
    </div>

    <!---------- Loading Overlay ---------->
    <div id="loading-overlay" class="modal overlay" style="display: none;">
      <div class="justify-content-center w-100">
        <div class="display-4 text-center text-white mb-4">
          Probably working on something...
        </div>
        <div class="mx-auto" style="width: 3rem;">
          <div
            class="spinner-border text-center text-light"
            style="width: 3rem; height: 3rem;"
            role="status"
          >
            <span class="sr-only">Loading...</span>
          </div>
        </div>
      </div>
    </div>
  </body>

  <!-- <<<<<<< Scripts Start >>>>>>> -->
  <script>
    // Loading state: Disable buttons in page
    //   and display loading overlay
    function loadingOn() {
      $("#my-body")
        .filter(":button")
        .each(function() {
          $(this).attr("disabled", true);
        });
      $("#loading-overlay").css("display", "flex");
    }

    // Normal state: Enable buttons in page
    //  and hide loading overlay
    function loadingOff() {
      $("#my-body")
        .filter(":button")
        .each(function() {
          $(this).attr("disabled", false);
        });
      $(".modal").each(function() {
        $(this).modal("hide");
      });
      $("#loading-overlay").css("display", "none");
    }

    // Wait for window load and refresh user and content
    window.addEventListener("load", function() {
      // Check for existing user cookies
      refreshUser();

      // Refresh content
      $.get("/api/v1/catalog", function(data) {
        refreshCatalog(data);
      });
    });
  </script>
  <script></script>
  <script>
    // Google O-Auth script recommended to be last
    var currentGUser;

    function makeid(length) {
      var text = "";
      var possible =
        "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      for (var i = 0; i < length; i++)
        text += possible.charAt(Math.floor(Math.random() * possible.length));
      return text;
    }

    function onSignIn(googleUser) {
      currentGUser = googleUser;
      // Because the Google O-Auth scripts run on their own
      //  automatically after refresh and ends up with
      //  calling this function, cookies are checked for
      //  already signed in user and then ignore
      //  the Google sign in action
      if (Cookies.get("user_id") && Cookies.get("token")) {
        return;
      }
      // Useful data for your client-side scripts:
      var profile = googleUser.getBasicProfile();
      // AJAX request to transparently create a
      //  user on the backend using the Google ID
      //  for username along with a randomly
      //  generated string for password
      // If the user is a returning the request
      //  will silently fail leaving the DB intact
      $.ajax({
        type: "POST",
        url: "/api/v1/users",
        // The key needs to match your method's input parameter (case-sensitive).
        data: JSON.stringify({
          username: "GU" + profile.getId(),
          password: makeid(20),
          picture: profile.getImageUrl(),
          email: profile.getEmail()
        }),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function(data) {
          loadingOn();
          signInAction(
            "GU" + profile.getId(),
            googleUser.getAuthResponse().id_token
          );
        },
        failure: function(errMsg) {
          console.log("Status: " + status);
          console.log("errMsg: " + errMsg);
        }
      });
    }
  </script>

  <!-- Events aren't correctly attached unless moved to the end -->
  <script src="js/events.js"></script>
</html>
